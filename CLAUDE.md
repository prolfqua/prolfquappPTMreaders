# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

prolfquappPTMreaders is an R package that extends the prolfquapp package to support Post-Translational Modification (PTM) analysis. It provides specialized reader functions and preprocessing pipelines for PTM-centric output formats generated by FragPipe.

The package is designed to be used as an external reader module for prolfquapp via the `ext_reader` configuration in YAML files.

## Package Architecture

### Core Components

**File Readers** (`get_FP_*_files` functions):
- Locate FragPipe output files and FASTA databases in a given path
- Return structured lists with paths to data files, FASTA files, and manifests
- Three variants: `get_FP_multi_site_files`, `get_FP_single_site_files`, `get_FP_combined_STY_files`

**Data Parsers** (`read_*` functions):
- Convert FragPipe PTM output formats to tidy long-format data frames
- Handle column renaming and pivoting operations
- Two main parsers: `read_FP_multisite_to_long` and `read_combined_STY_file`

**Preprocessors** (`preprocess_FP_*` functions):
- Main data processing pipeline that integrates with prolfquapp
- Configure hierarchical data structures for PTM analysis
- Join annotation data, create protein annotations from FASTA
- Filter contaminants and decoys
- Return lists containing `lfqdata` and `protein_annotation` objects

**Dataset Templates** (`dataset_template_FP_*` functions):
- Generate annotation template data frames with Group, Subject, Control columns
- Used to create initial experiment annotation files

### Data Flow

1. **File Discovery**: `get_FP_*_files()` locates input files in a directory
2. **Template Generation**: `dataset_template_FP_*()` creates annotation templates
3. **Preprocessing**: `preprocess_FP_*()` reads data, joins with annotations, and creates prolfqua objects
   - Reads raw data to long format
   - Joins with user-provided annotations
   - Sets up prolfqua configuration with hierarchical structure
   - Creates LFQData objects with protein annotations from FASTA

### PTM-Specific Processing

The package handles two main FragPipe PTM output formats:

**Multi-site Format** (`abundance_multi-site_None.tsv`):
- Supports both single-site and multi-site phosphorylation
- Extracts phosphorylation site information from Index field
- Parses site windows, positions, and localization counts
- Uses `MaxPepProb` as quality score

**Combined STY Format** (`combined_site_STY_*.tsv`):
- Handles combined S/T/Y phosphorylation site data
- Uses `Best Localization Probability` (BLP) as quality metric
- Integrates with FragPipe manifest files for sample metadata
- Pivots intensity and localization probability columns

### Hierarchy Configuration

PTM data uses a 2-level hierarchy:
- Level 1: `ProteinID` (protein level)
- Level 2: `Index~Peptide` (site level) - composite key combining modification index and peptide sequence

## Development Commands

### Building and Checking

```r
# Build package documentation
devtools::document()

# Install package locally
devtools::install()

# Check package
devtools::check()

# Run tests
devtools::test()
```

### Installation

Users install from GitHub:
```r
remotes::install_github("prolfqua/prolfquappPTMreaders", dependencies = TRUE)
```

## Integration with prolfquapp

This package is designed to be referenced in prolfquapp `config.yaml` files:

**For multi-site analysis:**
```yaml
ext_reader:
  extra_args: list(sitetype = 'multisite')
  preprocess: prolfquappPTMreaders::preprocess_FP_multi_site
  get_files: prolfquappPTMreaders::get_FP_multi_site_files
```

**For combined STY analysis:**
```yaml
ext_reader:
  extra_args: list(annotation_join_by = c("raw.file", "Name"))
  preprocess: prolfquappPTMreaders::preprocess_FP_combined_STY
  get_files: prolfquappPTMreaders::get_FP_combined_STY_files
```

The `prolfqua_preprocess_functions` list in `R/prolfqua_preprocess_functions.R` documents all available reader configurations.

## Key Dependencies

- **prolfquapp**: Parent package providing core proteomics analysis functionality
- **prolfqua**: Underlying framework for label-free quantification
- **tidyverse packages**: dplyr, tidyr, readr for data manipulation
- **rlang**: For non-standard evaluation and tidy evaluation

## Function Signature Compatibility

Preprocessor functions must maintain signature compatibility with `prolfquapp::preprocess_dummy()`:
- `quant_data`: Path to quantification file
- `fasta_file`: Path to FASTA database
- `annotation`: List containing annotation data and table configuration
- Additional specific parameters (e.g., `pattern_contaminants`, `pattern_decoys`, `annotation_join_by`)

File getter functions must match `prolfquapp::get_dummy_files()` signature:
- Single `path` parameter
- Return list with `data`, `fasta`, and optionally `fp.manifest` elements
